import{_ as e}from"./ContentWrap.vue_vue_type_script_setup_true_lang-Bjl2qjEM.js";import{d as l,r as a,ad as t,N as o,s as n,e as i,v as s,B as r,C as u,D as c,G as p,F as d,K as m,H as g,V as v,y as f,o as y,c as h,w as _,a as x,z as j,t as b,A as w,f as k,W as S,I as C,bz as V,E,S as L,j as T,J as $,l as z,M as I,_ as U}from"./index-D9UQcSFE.js";import{a as A,E as F}from"./el-col-CXXou3fy.js";import{E as H}from"./el-text-nFwZ0AHD.js";import{E as M}from"./el-upload-LZeOK5Ti.js";import"./el-progress-DiltV8uQ.js";import"./el-tooltip-l0sNRNKZ.js";import{E as O}from"./el-popper-CI0yhH6M.js";import{E as D,a as R,b as W}from"./el-dropdown-item-C-MClRcm.js";import{E as P}from"./el-switch-B9n_0JFR.js";import{E as N}from"./el-drawer-bw6GB9YA.js";import{E as B}from"./el-space-B2KBkAnB.js";import{_ as q}from"./Table.vue_vue_type_script_lang-BwmIaq25.js";import{u as K}from"./useTable-CbxTkDDT.js";import{u as G}from"./useIcon-Dp8bmm5Q.js";import{_ as J}from"./Dialog.vue_vue_type_style_index_0_lang-DeqRaDiv.js";import{e as Y,f as Z,h as Q,m as X,j as ee,k as le,n as ae,c as te}from"./index-BdT7lvrf.js";import oe from"./detail-BjUg3oZN.js";import"./el-card-DCo43hKN.js";import"./index-BOy3-hgS.js";import"./el-pagination-C9wpkp8F.js";import"./el-select-Dv9vCEmJ.js";import"./el-tag-kYKN7H0G.js";import"./strings-CBvC00KA.js";import"./useInput-DYqoIpgX.js";import"./debounce-CgKOJkOb.js";import"./castArray-Bow0xsjh.js";import"./refs-wNcffJKd.js";import"./el-dialog-Dx-yfAYV.js";import"./el-table-column-Bzxs424x.js";import"./el-checkbox-t7oy-lx0.js";import"./isArrayLikeObject-CT7DS3OS.js";import"./raf-B6O9U2CX.js";import"./el-image-viewer-gZ5dQPUY.js";import"./el-empty-CBFdbnl8.js";import"./tsxHelper-Dc2XHH9E.js";import"./index-BGn7iVRV.js";import"./index-BRGVtAVt.js";import"./el-form-ClIvQroC.js";import"./el-tab-pane-CbJd8YfH.js";import"./index-r_ORVl1e.js";import"./index-DRPh3UHe.js";const ne={class:"flex flex-wrap gap-3 items-center"},ie={style:{position:"relative",top:"12px"}},se={style:{display:"flex","align-items":"center","justify-content":"space-between",width:"100%"}},re={style:{"font-weight":"500"}},ue={style:{display:"flex","flex-direction":"column",height:"100%"}},ce={style:{padding:"16px",background:"#1e1e1e",color:"#d4d4d4","font-family":"'Consolas', 'Monaco', 'Courier New', monospace","font-size":"13px","line-height":"1.6","min-height":"100%","white-space":"pre-wrap","word-wrap":"break-word"}},pe={key:0},de=["innerHTML"],me={key:1},ge=["innerHTML"],ve={key:2,style:{color:"#888","text-align":"center",padding:"40px"}},fe={style:{padding:"16px","border-top":"1px solid var(--el-border-color)",display:"flex","justify-content":"space-between","align-items":"center"}},ye={style:{color:"var(--el-text-color-secondary)","font-size":"12px"}},he={key:0},_e={key:1},xe={class:"flex flex-col gap-2"};function je(e){return"function"==typeof e||"[object Object]"===Object.prototype.toString.call(e)&&!$(e)}const be=U(l({__name:"ServerPlugin",setup(l){const $=G({icon:"iconoir:search"}),{t:U}=z(),be=a(""),we=()=>{Fe()},ke=t("openMarketDialog",(()=>{})),Se=t("pendingPluginsCount",a(0)),Ce=o((()=>Se.value)),Ve=n([{field:"index",label:U("tableDemo.index"),type:"index",minWidth:"15"},{field:"selection",type:"selection",minWidth:55},{field:"name",label:U("plugin.name"),formatter:(e,l,a)=>i("a",{href:`https://plugin.scope-sentry.top/plugin/${e.hash}`,style:"color: #409EFF; text-decoration: none;",target:"_blank"},[a])},{field:"status",label:U("plugin.status"),minWidth:100,formatter:(e,l,a)=>i(P,{modelValue:a??!1,onChange:async l=>{const a=l;try{await X(e.hash,a),e.status=a,Fe()}catch(t){}},activeText:"",inactiveText:""},null)},{field:"lastTime",label:U("task.lastTime"),minWidth:100,formatter:(e,l,a)=>""==a?"-":a},{field:"nextTime",label:U("task.nextTime"),minWidth:100,formatter:(e,l,a)=>""==a||0==e.state?"-":a},{field:"version",label:U("plugin.version"),minWidth:50},{field:"introduction",label:U("plugin.introduction"),minWidth:200},{field:"action",label:U("tableDemo.action"),minWidth:"300",fixed:"right",formatter:(e,l,a)=>{let t,o,n,m;const g=s(W,{onCommand:l=>{switch(l){case"reinstall":ee("all",e.hash,e.module);break;case"runOnce":Be(e.hash)}}},{default:()=>s(r,{style:{outline:"none",boxShadow:"none"}},(()=>[U("common.operation"),s(u,{},(()=>s(c)))])),dropdown:()=>s(D,null,(()=>[s(R,{command:"reinstall"},(()=>U("plugin.reInstall"))),s(R,{command:"runOnce"},(()=>U("plugin.runOnce")))]))});return i(d,null,[g,i(p,{type:"warning",style:{marginLeft:"10px"},onClick:()=>ml(e)},je(t=U("common.log"))?t:{default:()=>[t]}),i(p,{type:"info",style:{marginLeft:"10px"},onClick:()=>Ne(e.hash,e.module)},je(o=U("common.cleanLog"))?o:{default:()=>[o]}),i(p,{type:"success",onClick:()=>Qe(e.id,e.hash)},je(n=U("common.edit"))?n:{default:()=>[n]}),i(p,{type:"danger",onClick:()=>Pe(e.hash,e.module),disabled:e.isSystem},je(m=U("common.delete"))?m:{default:()=>[m]})])}}]),{tableRegister:Ee,tableState:Le,tableMethods:Te}=K({fetchDataApi:async()=>{const{currentPage:e,pageSize:l}=Le,a=await le(be.value,e.value,l.value,"server");return{list:a.data.list,total:a.data.total}},immediate:!1}),{loading:$e,dataList:ze,total:Ie,currentPage:Ue,pageSize:Ae}=Le;Ae.value=20;const{getList:Fe,getElTableExpose:He}=Te;function Me(){return{background:"var(--el-fill-color-light)"}}const Oe=a(!1);let De=U("plugin.new");const Re=()=>{Oe.value=!1},We=async()=>{m({title:"Delete",draggable:!0}).then((async()=>{await Ge()}))},Pe=async(e,l)=>{m({title:"Delete",draggable:!0}).then((async()=>{await Ke(e,l)}))},Ne=async(e,l)=>{m({title:"Clean Log",message:"Are you sure you want to clean the logs?",draggable:!0}).then((async()=>{await Y(l,e,"server")}))},Be=async e=>{m({title:U("plugin.runOnce"),message:U("plugin.runOnceConfirm"),draggable:!0}).then((async()=>{try{await ae(e),I.success(U("plugin.runOnceSuccess"))}catch(l){I.error(U("plugin.runOnceFailed"))}})).catch((()=>{}))},qe=a(!1),Ke=async(e,l)=>{qe.value=!0;try{await Z([{hash:e,module:l}]);qe.value=!1,Fe()}catch(a){qe.value=!1,Fe()}},Ge=async()=>{const e=await He(),l=((null==e?void 0:e.getSelectionRows())||[]).map((e=>({hash:e.hash,module:e.module})));qe.value=!0;try{await Z(l);qe.value=!1,Fe()}catch(a){qe.value=!1,Fe()}},Je=async()=>{Ye.value="",Oe.value=!0},Ye=a(""),Ze=a(""),Qe=async(e,l)=>{Ye.value=e,Ze.value=l,De=U("common.edit"),Oe.value=!0},Xe=a(!1),el=a(""),ll=async()=>{if(el.value){200==(await te(el.value)).code&&(localStorage.setItem("plugin_key",el.value),Xe.value=!1)}},al=()=>{el.value?localStorage.setItem("plugin_key",el.value):localStorage.removeItem("plugin_key")};g((()=>{ol(),window.addEventListener("resize",ol),(()=>{const e=localStorage.getItem("plugin_key");e||(Xe.value=!0),el.value=e||""})(),Fe()}));const tl=a(0),ol=()=>{const e=window.innerHeight||document.documentElement.clientHeight;tl.value=.7*e},nl=a(!1),il=()=>{nl.value=!1,rl.value=""},sl=a(""),rl=a(""),ul=a(),cl=a(!0),pl=a(""),dl=a(""),ml=async e=>{pl.value=e.module,dl.value=e.hash,await gl(),nl.value=!0,setTimeout((()=>{fl()}),100)},gl=async()=>{const e=await Q("",dl.value,"server");sl.value=e.data.data,cl.value&&setTimeout((()=>{fl()}),50)},vl=async()=>{await Y(pl.value,dl.value,"server"),sl.value="",I.success(U("common.cleanLog")+" "+U("common.success"))},fl=()=>{if(ul.value){const e=ul.value.$el,l=null==e?void 0:e.querySelector(".el-scrollbar__wrap");l&&(l.scrollTop=l.scrollHeight)}},yl=async()=>{if(sl.value)try{await navigator.clipboard.writeText(sl.value),I.success(U("common.copySuccess"))}catch(e){I.error(U("common.copyFailed"))}},hl=o((()=>{if(!rl.value||!sl.value)return sl.value;const e=rl.value;return sl.value.split("\n").filter((l=>l.toLowerCase().includes(e.toLowerCase()))).join("\n")})),_l=e=>{const l=document.createElement("div");return l.textContent=e,l.innerHTML},xl=e=>{if(!e)return"";let l=(e=>e?e.replace(/<color\s+value=["']([^"']+)["'](?:\s+bold)?\s*>((?:[^<]|<(?!\/color>))*?)<\/color>/gi,((e,l,a)=>{if(!(t=l)||(t=t.trim(),/[<>'"`]/.test(t)||/javascript:/i.test(t)||/on\w+=/i.test(t)||!/^#([0-9A-Fa-f]{3}|[0-9A-Fa-f]{6})$/.test(t)&&!/^rgba?\(\s*\d+\s*,\s*\d+\s*,\s*\d+\s*(,\s*[\d.]+\s*)?\)$/.test(t)))return _l(e);var t;const o=/\s+bold\s*>/i.test(e),n=_l(a),i=[`color: ${l}`];return o&&i.push("font-weight: bold"),`<span style="${i.join("; ")}">${n}</span>`})):"")(e);const a="___COLOR_SPAN___",t=[];if(l=l.replace(/<span style="[^"]+">[^<]*<\/span>/g,(e=>(t.push(e),a+(t.length-1)+a))),l=_l(l),t.forEach(((e,t)=>{l=l.replace(a+t+a,e)})),rl.value){const e=rl.value,a=_l(e),t=new RegExp(`(${a.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")})`,"gi");l=l.replace(t,(e=>e.includes("<span")?e.replace(/(<span[^>]*>)(.*?)(<\/span>)/g,((e,l,t,o)=>{const n=new RegExp(`(${a.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")})`,"gi");return`${l}${t.replace(n,"<mark>$1</mark>")}${o}`})):`<mark>${e}</mark>`))}return l},jl={Authorization:`${v().getToken}`},bl=a(),wl=e=>{bl.value.clearFiles();const l=e[0];bl.value.handleStart(l)},kl=e=>{var l;200===e.code?I.success("Upload succes"):I.error(e.message),505==e.code&&localStorage.removeItem("plugin_key"),Fe(),null==(l=bl.value)||l.clearFiles()},Sl=(e,l)=>{l.length>0&&bl.value.submit()};return(l,a)=>{const t=f("Icon");return y(),h(d,null,[i(x(e),null,{default:_((()=>[i(x(A),null,{default:_((()=>[i(x(F),{span:1},{default:_((()=>[i(x(H),{class:"mx-1",style:{position:"relative",top:"8px"}},{default:_((()=>[j(b(x(U)("plugin.name"))+":",1)])),_:1})])),_:1}),i(x(F),{span:5},{default:_((()=>[i(x(w),{modelValue:be.value,"onUpdate:modelValue":a[0]||(a[0]=e=>be.value=e),placeholder:x(U)("common.inputText"),style:{height:"38px"}},null,8,["modelValue","placeholder"])])),_:1}),i(x(F),{span:5,style:{position:"relative",left:"16px"}},{default:_((()=>[i(x(r),{type:"primary",icon:x($),style:{height:"100%"},onClick:we},{default:_((()=>[j("Search")])),_:1},8,["icon"])])),_:1}),i(x(F),{span:1,style:{position:"relative",left:"32px"}},{default:_((()=>[i(x(H),{class:"mx-1",style:{position:"relative",top:"8px"}},{default:_((()=>[j(b(x(U)("plugin.key"))+":",1)])),_:1})])),_:1}),i(x(F),{span:5,style:{position:"relative",left:"32px"}},{default:_((()=>[i(x(w),{modelValue:el.value,"onUpdate:modelValue":a[1]||(a[1]=e=>el.value=e),placeholder:x(U)("plugin.key"),style:{height:"38px"},onBlur:al},null,8,["modelValue","placeholder"])])),_:1})])),_:1}),i(x(A),{gutter:16,class:"mt-4"},{default:_((()=>[i(x(F),{xs:24,sm:24,md:24,lg:24,xl:24},{default:_((()=>[k("div",ne,[i(x(p),{type:"primary",onClick:Je},{default:_((()=>[j(b(x(U)("plugin.new")),1)])),_:1}),i(x(p),{type:"danger",loading:qe.value,onClick:We},{default:_((()=>[j(b(x(U)("plugin.delete")),1)])),_:1},8,["loading"]),i(x(S),{value:Ce.value,hidden:0===Ce.value,max:99},{default:_((()=>[i(x(p),{type:"success",onClick:x(ke)},{default:_((()=>[j(b(x(U)("plugin.market")),1)])),_:1},8,["onClick"])])),_:1},8,["value","hidden"]),i(x(M),{ref_key:"upload",ref:bl,class:"flex items-center",action:"/api/plugin/import?key="+(el.value||""),headers:jl,"on-success":kl,limit:1,"on-exceed":wl,"auto-upload":!1,onChange:Sl},{trigger:_((()=>[i(x(p),null,{icon:_((()=>[i(t,{icon:"iconoir:upload"})])),default:_((()=>[j(" "+b(x(U)("plugin.import")),1)])),_:1})])),_:1},8,["action"])])])),_:1})])),_:1}),k("div",ie,[i(x(q),{pageSize:x(Ae),"onUpdate:pageSize":a[2]||(a[2]=e=>C(Ae)?Ae.value=e:null),currentPage:x(Ue),"onUpdate:currentPage":a[3]||(a[3]=e=>C(Ue)?Ue.value=e:null),columns:Ve,data:x(ze),stripe:"",border:!0,loading:x($e),resizable:!0,pagination:{total:x(Ie),pageSizes:[20,30,50,100,200,500,1e3]},onRegister:x(Ee),headerCellStyle:Me,style:{fontFamily:"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji"}},null,8,["pageSize","currentPage","columns","data","loading","pagination","onRegister"])])])),_:1}),i(x(N),{modelValue:Oe.value,"onUpdate:modelValue":a[4]||(a[4]=e=>Oe.value=e),title:x(De),size:"50%",direction:"rtl"},{default:_((()=>[i(oe,{closeDialog:Re,getList:x(Fe),id:Ye.value,tp:"server",hash:Ze.value},null,8,["getList","id","hash"])])),_:1},8,["modelValue","title"]),i(x(N),{modelValue:nl.value,"onUpdate:modelValue":a[7]||(a[7]=e=>nl.value=e),title:x(U)("node.log"),size:"80%",direction:"rtl","with-header":!0},{header:_((()=>[k("div",se,[k("span",re,b(x(U)("node.log")),1),i(x(B),null,{default:_((()=>[i(x(w),{modelValue:rl.value,"onUpdate:modelValue":a[5]||(a[5]=e=>rl.value=e),placeholder:x(U)("common.search"),clearable:"",style:{width:"200px"}},{prefix:_((()=>[i(x(u),null,{default:_((()=>[i(x(V))])),_:1})])),_:1},8,["modelValue","placeholder"]),i(x(P),{modelValue:cl.value,"onUpdate:modelValue":a[6]||(a[6]=e=>cl.value=e),"active-text":x(U)("common.autoScroll"),"inactive-text":""},null,8,["modelValue","active-text"])])),_:1})])])),default:_((()=>[k("div",ue,[i(x(E),{ref_key:"logScrollbarRef",ref:ul,style:{flex:"1",height:"0"}},{default:_((()=>[k("div",ce,[rl.value&&hl.value?(y(),h("div",pe,[(y(!0),h(d,null,L(hl.value.split("\n"),((e,l)=>(y(),h("div",{key:l,innerHTML:xl(e)},null,8,de)))),128))])):sl.value?(y(),h("div",me,[(y(!0),h(d,null,L(sl.value.split("\n"),((e,l)=>(y(),h("div",{key:l,innerHTML:xl(e)},null,8,ge)))),128))])):(y(),h("div",ve,b(x(U)("common.noData")),1))])])),_:1},512),k("div",fe,[k("div",ye,[rl.value?(y(),h("span",he,b(x(U)("common.searchResult"))+": "+b(hl.value.split("\n").filter((e=>e)).length)+" "+b(x(U)("common.lines")),1)):sl.value?(y(),h("span",_e,b(sl.value.split("\n").filter((e=>e)).length)+" "+b(x(U)("common.lines")),1)):T("",!0)]),i(x(B),null,{default:_((()=>[i(x(p),{onClick:gl,type:"primary"},{default:_((()=>[j(b(x(U)("common.refresh")),1)])),_:1}),i(x(p),{onClick:yl,type:"info"},{default:_((()=>[j(b(x(U)("common.copy")),1)])),_:1}),i(x(p),{onClick:vl,type:"danger"},{default:_((()=>[j(b(x(U)("common.cleanLog")),1)])),_:1}),i(x(p),{onClick:il},{default:_((()=>[j(b(x(U)("common.off")),1)])),_:1})])),_:1})])])])),_:1},8,["modelValue","title"]),i(x(J),{modelValue:Xe.value,"onUpdate:modelValue":a[9]||(a[9]=e=>Xe.value=e),title:x(U)("plugin.key"),center:"",width:"30%",style:{"max-width":"400px",height:"200px"}},{default:_((()=>[k("div",xe,[i(x(O),{class:"item",effect:"dark",content:x(U)("plugin.keyMsg"),placement:"top"},{default:_((()=>[i(x(w),{modelValue:el.value,"onUpdate:modelValue":a[8]||(a[8]=e=>el.value=e)},null,8,["modelValue"])])),_:1},8,["content"]),i(x(p),{onClick:ll,type:"primary",class:"w-full"},{default:_((()=>[j("Save")])),_:1})])])),_:1},8,["modelValue","title"])],64)}}}),[["__scopeId","data-v-5298e0ce"]]);export{be as default};
