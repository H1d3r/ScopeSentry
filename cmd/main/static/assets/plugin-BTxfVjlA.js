import{d as e,r as t,N as l,O as s,H as a,o as i,c as r,e as o,w as n,a as p,i as u,j as m,P as c,F as d,l as g,M as v,K as j}from"./index-D9UQcSFE.js";import{E as f,a as _}from"./el-tab-pane-CbJd8YfH.js";import{_ as y}from"./ClientPlugin.vue_vue_type_script_setup_true_lang-BUEAtT0M.js";import h from"./ServerPlugin-DeKVJcXV.js";import b from"./PluginMarket-DcAjnxAb.js";import{g as x,a as k,b as w,i as P}from"./index-BdT7lvrf.js";import"./strings-CBvC00KA.js";import"./ContentWrap.vue_vue_type_script_setup_true_lang-Bjl2qjEM.js";import"./el-card-DCo43hKN.js";import"./el-tooltip-l0sNRNKZ.js";import"./el-popper-CI0yhH6M.js";import"./el-col-CXXou3fy.js";import"./el-text-nFwZ0AHD.js";import"./el-tag-kYKN7H0G.js";import"./el-upload-LZeOK5Ti.js";import"./el-progress-DiltV8uQ.js";import"./index-BOy3-hgS.js";import"./el-dropdown-item-C-MClRcm.js";import"./el-pagination-C9wpkp8F.js";import"./el-select-Dv9vCEmJ.js";import"./useInput-DYqoIpgX.js";import"./debounce-CgKOJkOb.js";import"./castArray-Bow0xsjh.js";import"./refs-wNcffJKd.js";import"./el-drawer-bw6GB9YA.js";import"./el-dialog-Dx-yfAYV.js";import"./el-space-B2KBkAnB.js";import"./el-switch-B9n_0JFR.js";import"./Table.vue_vue_type_script_lang-BwmIaq25.js";import"./el-table-column-Bzxs424x.js";import"./el-checkbox-t7oy-lx0.js";import"./isArrayLikeObject-CT7DS3OS.js";import"./raf-B6O9U2CX.js";import"./el-image-viewer-gZ5dQPUY.js";import"./el-empty-CBFdbnl8.js";import"./tsxHelper-Dc2XHH9E.js";import"./index-BGn7iVRV.js";import"./useTable-CbxTkDDT.js";import"./useIcon-Dp8bmm5Q.js";import"./Dialog.vue_vue_type_style_index_0_lang-DeqRaDiv.js";import"./detail-BjUg3oZN.js";import"./el-form-ClIvQroC.js";import"./index-r_ORVl1e.js";import"./index-DRPh3UHe.js";import"./index-BRGVtAVt.js";import"./el-radio-group-Bkh-faiF.js";/* empty css                        */const S=e({__name:"plugin",setup(e){const{t:S}=g(),I=t("client"),C=t(!1),T=t([]),M=t(!1),A=t(""),E=t(),F=t(),L=async()=>{var e,t;M.value=!0;try{const[l,s]=await Promise.all([x(),k()]),a=new Map;200===l.code&&(null==(e=l.data)?void 0:e.list)&&l.data.list.forEach((e=>{a.set(e.hash,e)}));let i=[];"200"===s.status&&(null==(t=s.data)?void 0:t.data)&&(i=s.data.data.map((e=>{var t;const l=a.get(e.hash),s=!!l;let i=!1;if(s&&l){const t=l.version||"",s=e.version||"";i=t!==s&&null!==s&&""!==s}let r=!1;if(e.tags){r=e.tags.split(",").map((e=>e.trim())).includes("内置")}return{id:e.id,name:(null==(t=e.name)?void 0:t.trim())||e.hash||`插件-${e.id}`,module:e.module||"",priceStatus:e.priceStatus,price:e.price,hash:e.hash||"",introduction:e.introduction||"",version:e.version||"",createTime:e.createTime||"",username:e.username||"",isInstalled:s,needUpdate:i,isSystem:r,type:e.type||"scan"}}))),T.value=i}catch(l){v.error("获取插件列表失败")}finally{M.value=!1}},R=async(e,t)=>{var l,s,a,i,r,o;try{const p=e.isInstalled&&e.needUpdate?S("plugin.update"):S("plugin.install");let u="未知插件";if(e&&e.name){const t=String(e.name).trim();t&&(u=t)}if(0===e.priceStatus){const e=S("plugin.confirmInstall",{action:p,name:u});await j.confirm(e,S("common.reminder"),{confirmButtonText:S("common.ok"),cancelButtonText:S("common.cancel"),type:"info"})}const m=v({message:`${p}中...`,type:"info",duration:0,showClose:!1});try{const r=await w(e.hash,t);if("200"!==r.status||!r.data)return m.close(),void v.error(r.message||"获取插件数据失败");const{json:o,source:n}=r.data,u=await P(o||"",n||"",e.isSystem||!1,A.value||"");if(m.close(),200===u.code){const e=S("plugin.installSuccess",{action:p});v.success(e),null==(s=null==(l=E.value)?void 0:l.refreshList)||s.call(l),null==(i=null==(a=F.value)?void 0:a.refreshList)||i.call(a),L()}else v.error(u.message||S("plugin.installFailed"))}catch(n){m.close(),v.error((null==(o=null==(r=null==n?void 0:n.response)?void 0:r.data)?void 0:o.message)||(null==n?void 0:n.message)||S("plugin.installFailed"))}}catch(n){}},U=l((()=>T.value.filter((e=>!e.isInstalled||e.needUpdate)).length));return s("openMarketDialog",(()=>{C.value=!0,0===T.value.length&&L()})),s("pendingPluginsCount",U),a((()=>{const e=localStorage.getItem("plugin_key");A.value=e||"",L()})),(e,t)=>(i(),r(d,null,[o(p(_),{type:"border-card",modelValue:I.value,"onUpdate:modelValue":t[0]||(t[0]=e=>I.value=e)},{default:n((()=>[o(p(f),{label:p(S)("plugin.clientPlugin"),name:"client"},{default:n((()=>[(i(),u(c,null,["client"===I.value?(i(),u(y,{key:0,ref_key:"clientPluginRef",ref:E},null,512)):m("",!0)],1024))])),_:1},8,["label"]),o(p(f),{label:p(S)("plugin.serverPlugin"),name:"server"},{default:n((()=>[(i(),u(c,null,["server"===I.value?(i(),u(h,{key:0,ref_key:"serverPluginRef",ref:F},null,512)):m("",!0)],1024))])),_:1},8,["label"])])),_:1},8,["modelValue"]),o(b,{visible:C.value,"remote-plugin-list":T.value,"market-loading":M.value,onClose:t[1]||(t[1]=e=>C.value=!1),onRefresh:L,onInstall:R},null,8,["visible","remote-plugin-list","market-loading"])],64))}});export{S as default};
